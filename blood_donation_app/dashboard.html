<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Blood Donation Dashboard</title>
<style>
    body {
        margin: 0;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f9f9f9;
        display: flex;
        height: 100vh;
        overflow: hidden;
    }
    .sidebar {
        width: 250px;
        background-color: #c62828;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 30px 10px;
        box-shadow: 3px 0 10px rgba(0, 0, 0, 0.2);
    }
    .sidebar h2 { font-size: 22px; margin-bottom: 30px; letter-spacing: 1px; }
    .sidebar button {
        background: transparent; color: #fff; border: none;
        font-size: 16px; width: 100%; text-align: left;
        padding: 12px 20px; margin: 8px 0; border-radius: 8px;
        transition: background 0.3s; cursor: pointer;
    }
    .sidebar button:hover, .sidebar button.active { background-color: #b71c1c; }
    .logout-btn {
        margin-top: auto; background-color: #f5f5f5; color: #c62828;
        font-weight: bold; border-radius: 20px; width: 80%;
        text-align: center; padding: 10px 0; cursor: pointer;
        transition: all 0.3s;
    }
    .logout-btn:hover { background-color: #fff; transform: scale(1.05); }
    .main { flex: 1; padding: 30px; overflow-y: auto; }
    h2 { color: #c62828; border-bottom: 3px solid #c62828; display: inline-block; padding-bottom: 6px; margin-bottom: 20px; }
    table {
        width: 100%; border-collapse: collapse; background-color: #fff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1); border-radius: 8px; overflow: hidden; margin-top: 15px;
    }
    th, td { padding: 14px; border-bottom: 1px solid #ddd; text-align: left; }
    th { background-color: #f44336; color: white; }
    tr:hover { background-color: #f5f5f5; }
    .profile-card {
        background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 25px; max-width: 500px;
    }
    .profile-card h3 { margin-top: 0; color: #c62828; }
    .profile-item { margin: 10px 0; font-size: 16px; }
    .profile-item strong { color: #444; }
    select, input { margin-top: 10px; padding: 8px; width: 200px; }
    button.search-btn {
        margin-top: 10px; padding: 8px 15px; background-color: #c62828;
        color: white; border: none; border-radius: 6px; cursor: pointer;
    }
    button.search-btn:hover { background-color: #b71c1c; }
    #requestMessage { margin-top: 10px; font-weight: bold; color: green; }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
    <h2>Blood Donation</h2>
    <button class="active" id="dashboardTab">üè† Dashboard</button>
    <button id="searchDonorsTab">üîç Search Donors</button>
    <button id="availableDonorsTab">‚ù§Ô∏è Available Donors</button>
    <button id="requestBloodTab">ü©∏ Request Blood</button>
    <button id="profileTab">üßç My Profile</button>
    <div class="logout-btn" id="logoutBtn">üö™ Logout</div>
</div>

<!-- Main -->
<div class="main" id="contentArea">
    <h2>Dashboard</h2>
    <p>Welcome to your Blood Donation Dashboard! Choose a section from the sidebar.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, collection, getDocs, addDoc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase setup
const firebaseConfig = {
    apiKey: "AIzaSyD2feneUfMuPYVwHMQ8wJgqnAkr7ul8BhQ",
    authDomain: "blooddonationapp-4998a.firebaseapp.com",
    projectId: "blooddonationapp-4998a",
    storageBucket: "blooddonationapp-4998a.appspot.com",
    messagingSenderId: "906121252187",
    appId: "1:906121252187:web:c44dbfadf4b1ee54021e7e"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;

onAuthStateChanged(auth, async (user) => {
    if (!user) window.location.href = 'login.html';
    else currentUser = user;
});

document.getElementById('logoutBtn').addEventListener('click', async () => {
    await signOut(auth);
    alert("Logged out successfully!");
    window.location.href = 'login.html';
});

const contentArea = document.getElementById('contentArea');
const buttons = document.querySelectorAll('.sidebar button');
buttons.forEach(btn => {
    btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (btn.id === 'dashboardTab') loadDashboard();
        else if (btn.id === 'searchDonorsTab') loadSearchDonors();
        else if (btn.id === 'availableDonorsTab') loadAvailableDonors();
        else if (btn.id === 'requestBloodTab') loadRequestBlood();
        else if (btn.id === 'profileTab') loadProfile();
    });
});

// Dashboard
function loadDashboard() {
    contentArea.innerHTML = `
        <h2>Dashboard</h2>
        <p>Welcome to your Blood Donation Dashboard! Use the sidebar to manage blood donors, requests, and your profile.</p>
    `;
}

// Search Donors
async function loadSearchDonors() {
    contentArea.innerHTML = `
        <h2>Search Donors</h2>
        <select id="bloodGroupFilter">
            <option value="">All Blood Groups</option>
            <option value="A+">A+</option><option value="A-">A-</option>
            <option value="B+">B+</option><option value="B-">B-</option>
            <option value="O+">O+</option><option value="O-">O-</option>
            <option value="AB+">AB+</option><option value="AB-">AB-</option>
        </select>
        <button class="search-btn" id="searchBtn">Search</button>
        <div id="searchResults"></div>
    `;
    document.getElementById('searchBtn').addEventListener('click', async () => {
        const bloodGroup = document.getElementById('bloodGroupFilter').value;
        let q = collection(db, "users");
        if (bloodGroup) q = query(collection(db, "users"), where("bloodGroup", "==", bloodGroup));
        const snapshot = await getDocs(q);
        let html = `<table><tr><th>Name</th><th>Blood Group</th><th>Email</th><th>Mobile</th><th>Last Donation</th></tr>`;
        snapshot.forEach(doc => {
            const d = doc.data();
            html += `<tr><td>${d.name||'-'}</td><td>${d.bloodGroup||'-'}</td><td>${d.email||'-'}</td><td>${d.mobile||'-'}</td><td>${d.lastDonation||'Never'}</td></tr>`;
        });
        html += `</table>`;
        document.getElementById('searchResults').innerHTML = snapshot.empty ? "<p>No donors found!</p>" : html;
    });
}

// Available Donors
async function loadAvailableDonors() {
    contentArea.innerHTML = `<h2>Available Donors</h2><p>Loading...</p>`;
    const snapshot = await getDocs(collection(db, "users"));
    let tableHTML = `<table><tr><th>Name</th><th>Blood Group</th><th>Email</th><th>Mobile</th><th>Last Donation</th></tr>`;
    snapshot.forEach(doc => {
        const d = doc.data();
        tableHTML += `<tr><td>${d.name||'-'}</td><td>${d.bloodGroup||'-'}</td><td>${d.email||'-'}</td><td>${d.mobile||'-'}</td><td>${d.lastDonation||'Never'}</td></tr>`;
    });
    tableHTML += `</table>`;
    contentArea.innerHTML = `<h2>Available Donors</h2>${snapshot.empty ? "<p>No donors found!</p>" : tableHTML}`;
}

// üß† Blood Request with AI urgency detection
async function loadRequestBlood() {
    contentArea.innerHTML = `
        <h2>Request Blood</h2>
        <form id="bloodRequestForm">
            <label>Blood Group:</label><br>
            <select id="requestBloodGroup" required>
                <option value="">Select Blood Group</option>
                <option value="A+">A+</option><option value="A-">A-</option>
                <option value="B+">B+</option><option value="B-">B-</option>
                <option value="O+">O+</option><option value="O-">O-</option>
                <option value="AB+">AB+</option><option value="AB-">AB-</option>
            </select><br>
            <label>Units Required:</label><br>
            <input type="number" id="units" min="1" required><br>
            <label>Hospital / Location:</label><br>
            <input type="text" id="hospital" placeholder="Hospital name or location" required><br>
            <label>Contact Number:</label><br>
            <input type="text" id="contact" maxlength="10" required><br>
            <label>Additional Notes:</label><br>
            <input type="text" id="notes" placeholder="e.g., emergency surgery, accident case"><br>
            <button type="submit" class="search-btn">Submit Request</button>
        </form>
        <div id="requestMessage"></div>
        <h3 style="margin-top:30px;">My Requests</h3><div id="myRequests"></div>
        <h3 style="margin-top:30px;">All Requests</h3><div id="allRequests"></div>
    `;

    const form = document.getElementById('bloodRequestForm');
    const messageDiv = document.getElementById('requestMessage');

    // üß† AI-like function
    function computeUrgency({units, hospital, notes}) {
        let score = 0;
        const u = Number(units) || 0;
        if (u >= 6) score += 40;
        else if (u >= 3) score += 20;
        else score += 5;
        const text = (hospital + ' ' + (notes||'')).toLowerCase();
        const emergencyWords = ["emergency", "urgent", "immediate", "critical", "accident", "surgery"];
        for (const w of emergencyWords) if (text.includes(w)) score += 40;
        score = Math.min(100, score + 10);
        if (score >= 70) return "High";
        if (score >= 35) return "Medium";
        return "Low";
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const bloodGroup = document.getElementById('requestBloodGroup').value;
        const units = document.getElementById('units').value;
        const hospital = document.getElementById('hospital').value.trim();
        const contact = document.getElementById('contact').value.trim();
        const notes = document.getElementById('notes').value.trim();

        if (contact.length !== 10 || isNaN(contact)) {
            alert("Enter a valid 10-digit contact number."); return;
        }

        const urgency = computeUrgency({units, hospital, notes});

        try {
            await addDoc(collection(db, "requests"), {
                uid: currentUser.uid,
                bloodGroup,
                units,
                hospital,
                contact,
                notes,
                urgency,
                createdAt: new Date()
            });
            messageDiv.innerText = `Blood request submitted! (Urgency: ${urgency})`;
            form.reset();
            loadUserRequests();
            loadAllRequests();
        } catch (err) { alert("Error: " + err.message); }
    });

    async function loadUserRequests() {
        const q = query(collection(db, "requests"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        const cont = document.getElementById('myRequests');
        if (snap.empty) { cont.innerHTML = "<p>No requests yet.</p>"; return; }
        let html = `<table><tr><th>Blood Group</th><th>Units</th><th>Hospital</th><th>Urgency</th><th>Date</th></tr>`;
        snap.forEach(doc => {
            const d = doc.data();
            const date = d.createdAt.seconds ? new Date(d.createdAt.seconds * 1000).toLocaleString() : new Date(d.createdAt).toLocaleString();
            html += `<tr><td>${d.bloodGroup}</td><td>${d.units}</td><td>${d.hospital}</td><td>${d.urgency}</td><td>${date}</td></tr>`;
        });
        html += `</table>`; cont.innerHTML = html;
    }

    async function loadAllRequests() {
        const q = query(collection(db, "requests"), orderBy("createdAt", "desc"));
        const snap = await getDocs(q);
        const cont = document.getElementById('allRequests');
        if (snap.empty) { cont.innerHTML = "<p>No requests available.</p>"; return; }
        let html = `<table><tr><th>User ID</th><th>Blood Group</th><th>Units</th><th>Hospital</th><th>Urgency</th><th>Date</th></tr>`;
        snap.forEach(doc => {
            const d = doc.data();
            const date = d.createdAt.seconds ? new Date(d.createdAt.seconds * 1000).toLocaleString() : new Date(d.createdAt).toLocaleString();
            html += `<tr><td>${d.uid}</td><td>${d.bloodGroup}</td><td>${d.units}</td><td>${d.hospital}</td><td>${d.urgency}</td><td>${date}</td></tr>`;
        });
        html += `</table>`; cont.innerHTML = html;
    }

    loadUserRequests(); loadAllRequests();
}

// Profile
async function loadProfile() {
    contentArea.innerHTML = `<h2>My Profile</h2><p>Loading your details...</p>`;
    if (!currentUser) return;
    const q = query(collection(db, "users"), where("uid", "==", currentUser.uid));
    const snap = await getDocs(q);
    if (snap.empty) { contentArea.innerHTML = `<h2>My Profile</h2><p>No user data found!</p>`; return; }
    const u = snap.docs[0].data();
    contentArea.innerHTML = `
        <h2>My Profile</h2>
        <div class="profile-card">
            <h3>${u.name || 'User'}</h3>
            <div class="profile-item"><strong>Email:</strong> ${u.email}</div>
            <div class="profile-item"><strong>Mobile:</strong> ${u.mobile || '-'}</div>
            <div class="profile-item"><strong>Address:</strong> ${u.address || '-'}</div>
            <div class="profile-item"><strong>Aadhaar Number:</strong> ${u.aadhar || '-'}</div>
            <div class="profile-item"><strong>Blood Group:</strong> ${u.bloodGroup || '-'}</div>
            <div class="profile-item"><strong>Last Donation:</strong> ${u.lastDonation || 'Never'}</div>
        </div>`;
}
</script>

<!-- ü©∏ AI Blood Assistant Section -->
<div style="margin: 40px auto; width: 600px; background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
  <h2 style="color: #e60000; text-align: center;">AI Blood Assistant ü§ñ</h2>
  <textarea id="userQuestion" placeholder="Ask me anything about blood donation..." 
            style="width: 100%; height: 80px; margin-top: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 8px;"></textarea>
  <button id="askAI" 
          style="width: 100%; background: #e60000; color: white; border: none; padding: 10px; margin-top: 10px; border-radius: 8px; cursor: pointer;">
          Ask AI
  </button>
  <div id="aiResponse" style="margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px; min-height: 60px;">
    <i>AI response will appear here...</i>
  </div>
</div>

<!-- üî• AI Assistant Script -->
<script>
document.getElementById("askAI").addEventListener("click", async () => {
  const question = document.getElementById("userQuestion").value.trim();
  const aiResponseDiv = document.getElementById("aiResponse");
  
  if (!question) {
    aiResponseDiv.innerHTML = "<i>Please type a question first!</i>";
    return;
  }

  aiResponseDiv.innerHTML = "<i>Thinking...</i>";

  try {
    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${"YOUR_API_KEY_HERE"}`
      },
      body: JSON.stringify({
        model: "gpt-4o-mini",
        messages: [
          { role: "system", content: "You are a helpful AI assistant that answers questions about blood donation, health, and donor awareness." },
          { role: "user", content: question }
        ]
      })
    });

    const data = await response.json();
    aiResponseDiv.innerHTML = data.choices[0].message.content || "No response received.";
  } catch (error) {
    aiResponseDiv.innerHTML = `<span style="color:red;">Error: ${error.message}</span>`;
  }
});
</script>

</body>
</html>    